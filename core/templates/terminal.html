{% extends "base.html" %}

{% block title %}Terminal de Box{% endblock %}

{% block head %}
    <style>
:root {
    --primary-color: #0d6efd;
    --success-color: #198754;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
}

.display-icon {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.status-icon {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.card {
    border-radius: 1rem;
    transition: all 0.3s ease;
}

.form-control, .form-select {
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
}

.input-group-text {
    border: 2px solid #dee2e6;
    border-right: none;
    background-color: #f8f9fa;
}

.input-group .form-control {
    border-left: none;
}

.input-group .form-control:focus + .input-group-text {
    border-color: var(--primary-color);
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
}

.modal-content {
    border: none;
    border-radius: 1rem;
}

.modal-header {
    border-bottom: none;
    padding: 1.5rem 1.5rem 0.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.toast {
    border-radius: 0.5rem;
    border: none;
}

@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    .card-body {
        padding: 1.2rem;
    }
    
    .display-icon {
        font-size: 2.5rem;
    }
        }
    </style>
{% endblock %}

{% block content %}

<!-- Loading Spinner -->
<div class="spinner-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<!-- Toast container único -->
<div id="toast-root" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Conteúdo da tela de Login/Seleção de Box -->
<div id="login-view" class="mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <!-- Card Principal -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="display-icon mb-3">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <h1 class="h3 mb-2">Terminal de Box</h1>
                        <p class="text-muted mb-0">Gerencie suas atividades e sessões</p>
                    </div>

                    <!-- Formulário de Box -->
                    <form id="box-form" class="mb-4">
                        <div class="form-group">
                            <label for="box-select" class="form-label">
                                <i class="bi bi-geo-alt me-2"></i>Selecione o Box
                            </label>
                            <select class="form-select form-select-lg" id="box-select" required>
                                <option value="" selected disabled>Escolha um box...</option>
                            </select>
                        </div>
                    </form>

                    <!-- Formulário de Matrícula -->
                    <form id="matricula-form">
                        <div class="form-group mb-4">
                            <label for="matricula" class="form-label">
                                <i class="bi bi-person-badge me-2"></i>Identificação
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">
                                    <i class="bi bi-upc-scan"></i>
                                </span>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="matricula"
                                       placeholder="Aproxime o crachá ou QR Code"
                                       autocomplete="off"
                                       autofocus>
                            </div>
                            <div class="form-text text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Use seu crachá ou código de identificação
                            </div>
                        </div>
                        <div class="d-grid gap-2 mb-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="confirmar-matricula-btn">
                                <i class="bi bi-check-circle me-2"></i>Confirmar Matrícula
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Card de Status -->
            <div class="card border-0 bg-light">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="status-icon me-3">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Status do Sistema</h6>
                            <p class="mb-0 text-muted small">
                                <span class="text-success">
                                    <i class="bi bi-check-circle me-1"></i>Online
                                </span>
                                - Pronto para uso
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Conteúdo da Aplicação após login -->
<div id="app-view" style="display:none;">
    <!-- A barra de navegação principal é fornecida pelo base.html. -->
    <!-- Conteúdo da Aplicação -->
    <div class="mt-4">
        <!-- Estado de Iniciar Sessão -->
        <div id="state-iniciar" class="state" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title">
                        <i class="bi bi-play-circle me-2"></i>
                        Iniciar Sessão
                    </h3>
                    <p class="card-text">Selecione uma atividade para iniciar a sessão:</p>
                    <form id="atividades-form-iniciar">
                        <ul id="atividades-iniciar-list" class="list-group list-group-flush mb-3"></ul>
                        <button type="submit" id="iniciar-btn" class="btn btn-success btn-lg w-100" style="display:none;">Iniciar Sessão</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Controles para sessão ativa -->
        <div id="sessao-ativa-controls" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-bold">Funcionário:</span> <span id="resumo-funcionario">-</span>
                            <span class="fw-bold ms-3">Box:</span> <span id="resumo-box">-</span>
                        </div>
                        <span class="badge bg-success" id="status-sessao">Em andamento</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <h4 class="mb-0 me-2"><i class="bi bi-clock"></i> Sessão em Andamento</h4>
                        <i class="bi bi-question-circle ms-2 text-secondary" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="right" title="Aqui você controla o tempo e as atividades da sua sessão. Adicione atividades, acompanhe o tempo e finalize quando terminar."></i>
                    </div>
                    <div class="session-timer mb-2" title="Clique para ver o horário de início" onclick="mostrarTooltipInicio()">
                        <i class="bi bi-clock timer-icon"></i>
                        <span class="timer-display">00:00:00</span>
                    </div>
                    <div id="info-inicio-sessao" class="mb-2 text-muted"></div>
                    <div class="progress mb-3" id="session-progress-bar-container" style="height: 12px; display: none;">
                        <div class="progress-bar" id="session-progress-bar" role="progressbar" style="width: 0%; min-width: 2px; height: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small text-muted">
                        <span><i class="bi bi-hourglass-split me-1"></i>Tempo Decorrido: <span id="session-elapsed-time">00:00:00</span></span>
                        <span><i class="bi bi-hourglass-bottom me-1"></i>Tempo Restante: <span id="session-remaining-time">00:00:00</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 small text-muted">
                        <span><i class="bi bi-calendar-check me-1"></i>Início: <span id="session-start-time">N/A</span></span>
                        <span><i class="bi bi-calendar-x me-1"></i>Estimativa Fim: <span id="session-end-time">N/A</span></span>
                    </div>

                    <div class="mb-2 fw-bold">Atividades da Sessão:</div>
                    <ul id="session-activities-list" class="list-group mb-3"></ul>
            
                    <!-- NOVO BLOCO: Adicionar atividades diretamente na tela -->
                    <form id="atividades-form-adicionar" style="display:none;" class="mb-3 border border-primary rounded p-3 bg-light position-relative">
                        <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                            <i class="bi bi-plus-circle me-2"></i>
                            <div>Adicionando novas atividades à sessão</div>
                        </div>
                        <ul id="atividades-adicionar-list" class="list-group list-group-flush mb-3" style="max-height: 200px; overflow-y: auto;"></ul>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill" id="btn-confirmar-adicao" disabled>Adicionar Atividades</button>
                            <button type="button" id="cancelar-adicionar-btn" class="btn btn-secondary flex-fill">Cancelar</button>
                        </div>
                    </form>
            
                    <button id="adicionarAtividadesBtn" class="btn btn-info btn-lg w-100 mb-2" aria-label="Adicionar Atividade"><i class="bi bi-plus-circle me-1"></i>Adicionar Atividade</button>
                    <button id="finalizarSessaoBtn" class="btn btn-danger btn-lg w-100" aria-label="Finalizar Sessão"><i class="bi bi-stop-circle me-1"></i>Finalizar Sessão</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Senha -->
<div class="modal fade" id="senhaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock me-2"></i>Autenticação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body pt-3">
                <form id="senha-form">
                    <div class="mb-4">
                        <label for="senha" class="form-label">Digite sua senha</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="bi bi-key"></i>
                            </span>
                            <input type="password" 
                                   class="form-control" 
                                   id="senha" 
                                   placeholder="Sua senha"
                                   required>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    id="togglePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Entrar
                        </button>
                        <button type="button" 
                                class="btn btn-light" 
                                data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
if (!localStorage.getItem('jwtToken')) {
    if (window.location.pathname !== '/terminal/') {
        window.location.href = '/terminal/';
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    console.log("DOMContentLoaded started.");
    // --- ELEMENTOS DO DOM ---
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const boxForm = document.getElementById('box-form');
    const selectBox = document.getElementById('box-select');
    const matriculaInput = document.getElementById('matricula');
    const matriculaForm = document.getElementById('matricula-form');
    const senhaModalElement = document.getElementById('senhaModal');
    const senhaModal = senhaModalElement ? new bootstrap.Modal(senhaModalElement) : null;
    let adicionarAtividadesModal; // Declare here, initialize after DOM is ready
    const toastRoot = document.getElementById('toast-root'); // Ensure this is always defined from base.html

    const senhaForm = document.getElementById('senha-form');
    const senhaInput = document.getElementById('senha');
    const togglePasswordBtn = document.getElementById('togglePassword');
    const spinnerOverlay = document.querySelector('.spinner-overlay');
    const welcomeMessageSpan = document.getElementById('welcome-message');
    const userNameSpan = document.getElementById('user-name');
    const atividadesIniciarList = document.getElementById('atividades-iniciar-list');
    const atividadesFormIniciar = document.getElementById('atividades-form-iniciar');
    const iniciarBtn = document.getElementById('iniciar-btn');
    const sessaoAtivaControls = document.getElementById('sessao-ativa-controls');
    const finalizarSessaoBtn = document.getElementById('finalizarSessaoBtn');
    const adicionarTriggerBtn = document.getElementById('adicionarAtividadesBtn');
    const atividadesContainer = document.getElementById('atividades-container');
    const atividadesFormAdicionar = document.getElementById('atividades-form-adicionar');
    const atividadesListAdicionar = document.getElementById('atividades-adicionar-list'); // Corrected ID for add modal list
    const adicionarBtn = document.getElementById('adicionar-btn');
    const cancelarAdicionarBtn = document.getElementById('cancelar-adicionar-btn');
    const atividadesTitle = document.getElementById('atividades-title');
    const estadoIniciar = document.getElementById('state-iniciar');

    // Progress bar elements (updated IDs)
    const sessionProgressBarContainer = document.getElementById('session-progress-bar-container');
    const sessionProgressBar = document.getElementById('session-progress-bar');
    const sessionProgressText = document.getElementById('session-progress-text');
    const sessionElapsedTime = document.getElementById('session-elapsed-time');
    const sessionRemainingTime = document.getElementById('session-remaining-time');
    const sessionStartTimeDisplay = document.getElementById('session-start-time');
    const sessionEndTimeDisplay = document.getElementById('session-end-time');
    const sessionActivitiesList = document.getElementById('session-activities-list');

    // --- ESTADO ---
    let funcionario = null;
    let jwtToken = localStorage.getItem('jwtToken') || null;
    let refreshToken = localStorage.getItem('refreshToken') || null;
    let boxId = null;
    let sessaoId = null;
    let sessionTimer;
    let startTime;
    let inicioFormatado = '';
    let currentMatricula = null; // Variável para armazenar a matrícula
    let totalSessionEstimatedDuration = 0; // Global variable for total duration

    // --- FUNÇÕES DE UI ---
    function showLoading() {
        if (spinnerOverlay) {
            spinnerOverlay.style.display = 'flex';
            console.log("Mostrar loading...");
        }
    }

    function hideLoading() {
        if (spinnerOverlay) {
            spinnerOverlay.style.display = 'none';
            console.log("Esconder loading...");
        }
    }

    function showToast(message, type = 'success') {
        if (!toastRoot) {
            console.error('Toast container (#toast-root) not found.');
            return;
        }
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastRoot.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    function showLoginView() {
        if (loginView && appView) {
            loginView.style.display = 'block';
            appView.style.display = 'none';
            selectBox.value = '';
            matriculaInput.value = '';
            senhaInput.value = '';
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('funcionario');
            funcionario = null;
            jwtToken = null;
            refreshToken = null;
            console.log("showLoginView() chamado");
            resetProgressBar();
        }
    }

    function showAppView() {
        if (loginView && appView) {
            loginView.style.display = 'none';
            appView.style.display = 'block';
            console.log("showAppView(): appView display set to block.");
            // Atualiza o nome do usuário na navbar principal do base.html
            const navbarUserSpan = document.querySelector('#navbarNav .dropdown-toggle span');
            if (funcionario && navbarUserSpan) {
                navbarUserSpan.textContent = funcionario.nome_completo;
                console.log("showAppView(): Welcome message updated for: ", funcionario.nome_completo);
            }
            console.log("showAppView() chamado");
        }
    }

    function showStateIniciar(selectedBoxId = null) {
        if (estadoIniciar && sessaoAtivaControls) {
            estadoIniciar.style.display = 'block';
            // sessao-ativa-controls should be hidden when starting new session
            sessaoAtivaControls.style.display = 'none';
            console.log("showStateIniciar(): estadoIniciar display set to block, sessaoAtivaControls hidden.");
            console.log("showStateIniciar(): boxId when called:", boxId); // Log the boxId here

            if (atividadesTitle) atividadesTitle.textContent = 'Selecione as atividades para iniciar:';
            if (iniciarBtn) iniciarBtn.style.display = 'inline-block';
            if (adicionarTriggerBtn) adicionarTriggerBtn.style.display = 'none';
            if (finalizarSessaoBtn) finalizarSessaoBtn.style.display = 'none';
            if (atividadesFormIniciar) atividadesFormIniciar.reset();
            
            if (selectedBoxId) {
                boxId = selectedBoxId;
                selectBox.value = selectedBoxId; // Restore selected box
            }

            loadActivitiesForInitiation();
            resetProgressBar(); // Ensure progress bar is reset
            console.log("showStateIniciar() chamado");
        }
    }

    function showStateActiveSession(sessionData) {
        if (estadoIniciar && sessaoAtivaControls) {
            estadoIniciar.style.display = 'none';
            // Make sure sessaoAtivaControls is explicitly shown
            sessaoAtivaControls.style.display = 'block';
            console.log("showStateActiveSession(): estadoIniciar hidden, sessaoAtivaControls display set to block.");

            sessaoId = sessionData.id;
            // Preserva o boxId existente se não houver um novo
            if (sessionData.box_id) {
                boxId = sessionData.box_id;
                selectBox.value = sessionData.box_id; // Keep box selected in dropdown
            }
            console.log("showStateActiveSession(): boxId atualizado:", boxId);

            const resumoFuncionario = document.getElementById('resumo-funcionario');
            const resumoBox = document.getElementById('resumo-box');
            let boxNome = sessionData.box_nome || (sessionData.box && sessionData.box.nome) || 'N/A';
            if (resumoFuncionario && funcionario) resumoFuncionario.textContent = funcionario.nome_completo || 'N/A';
            if (resumoBox) resumoBox.textContent = boxNome;
            console.log("showStateActiveSession(): Updated funcionario and box resume.", {funcionario: funcionario ? funcionario.nome_completo : 'N/A', box: boxNome});

            startTime = new Date(sessionData.data_hora_inicio);
            totalSessionEstimatedDuration = sessionData.atividades.reduce((sum, activity) => sum + activity.atividade.duracao_estimada, 0);
            // Exibe botões de controle da sessão
            if (adicionarAtividadesBtn) adicionarAtividadesBtn.style.display = 'inline-block';
            if (finalizarSessaoBtn) finalizarSessaoBtn.style.display = 'inline-block';

            renderSessionActivities(sessionData.atividades);
            startSessionTimer();
            
            if (sessionProgressBarContainer) {
                sessionProgressBarContainer.style.display = 'block'; // Make progress bar visible
                console.log("showStateActiveSession(): Progress bar container display set to block.");
            }

            // Preencher datas de início e fim
            if (sessionStartTimeDisplay) {
                sessionStartTimeDisplay.textContent = sessionData.data_hora_inicio
                    ? new Date(sessionData.data_hora_inicio).toLocaleTimeString('pt-BR')
                    : 'N/A';
            }
            if (sessionEndTimeDisplay) {
                if (sessionData.data_hora_inicio && totalSessionEstimatedDuration > 0) {
                    const inicio = new Date(sessionData.data_hora_inicio);
                    const estimativaFim = new Date(inicio.getTime() + totalSessionEstimatedDuration * 60 * 1000);
                    sessionEndTimeDisplay.textContent = estimativaFim.toLocaleTimeString('pt-BR');
                } else {
                    sessionEndTimeDisplay.textContent = 'N/A';
                }
            }

            console.log("showStateActiveSession() chamado");
        } else {
            console.warn("showStateActiveSession(): Required elements (estadoIniciar or sessaoAtivaControls) not found.");
        }
    }

    function showAdicionarAtividades() {
        if (sessaoAtivaControls && atividadesFormAdicionar) {
            // Exibe o bloco de controles da sessão ativa e o formulário de adicionar atividades
            sessaoAtivaControls.style.display = 'block';
            atividadesFormAdicionar.style.display = 'block';
            // Oculta o botão de adicionar e o de finalizar sessão, se necessário
            if (adicionarTriggerBtn) adicionarTriggerBtn.style.display = 'none';
            if (finalizarSessaoBtn) finalizarSessaoBtn.style.display = 'none';
            // Carrega as atividades
            loadActivitiesForAdding();
        }
        // Oculte o bloco de iniciar sessão
        if (estadoIniciar) estadoIniciar.style.display = 'none';
    }

    function resetProgressBar() {
        if (sessionProgressBarContainer) {
            sessionProgressBarContainer.style.display = 'none';
        }
        if (sessionProgressBar) {
            sessionProgressBar.style.width = '0%';
            sessionProgressBar.className = 'progress-bar bg-primary';
        }
        if (sessionProgressText) {
            sessionProgressText.textContent = '0%';
        }
        if (sessionElapsedTime) {
            sessionElapsedTime.textContent = '00:00:00';
        }
        if (sessionRemainingTime) {
            sessionRemainingTime.textContent = '00:00:00';
        }
        if (sessionStartTimeDisplay) {
            sessionStartTimeDisplay.textContent = 'N/A';
        }
        if (sessionEndTimeDisplay) {
            sessionEndTimeDisplay.textContent = 'N/A';
        }
        totalSessionEstimatedDuration = 0; // Reset estimated duration
    }

    // --- FUNÇÕES DE LÓGICA DE NEGÓCIO ---

    async function loadBoxes() {
        console.log('[LOG] loadBoxes() chamada.');
        showLoading();
        try {
            const boxes = await fetchAPI('/api/boxes/', {method: 'GET'});
            console.log('[LOG] Boxes fetched from API:', boxes);
            if (selectBox) {
                console.log('[LOG] selectBox element found.');
                selectBox.innerHTML = '<option value="" selected disabled>Escolha um box...</option>';
                if (boxes && boxes.length > 0) {
                    boxes.forEach(box => {
                        const option = document.createElement('option');
                        option.value = box.id;
                        option.textContent = box.nome;
                        selectBox.appendChild(option);
                    });
                    console.log('[LOG] Adicionados', boxes.length, 'boxes ao dropdown.');
                    // Se houver apenas um box, selecionar automaticamente
                    if (boxes.length === 1) {
                        selectBox.selectedIndex = 1; // 0 é o placeholder
                        boxId = boxes[0].id;
                        console.log('[LOG] Apenas um box disponível. Selecionado automaticamente:', boxId);
                    }
                } else {
                    console.log('[LOG] Nenhuma box retornada pela API ou array de boxes vazio.');
                }
            } else {
                console.warn('[LOG] Elemento selectBox não encontrado.');
            }
        } catch (error) {
            showToast('Erro ao carregar boxes: ' + error.message, 'danger');
            console.error('[LOG] Erro ao carregar boxes:', error);
        } finally {
            hideLoading();
        }
    }

    async function fetchAPI(url, options = {}) {
        let currentToken = localStorage.getItem('jwtToken');
        options.headers = {
            'Content-Type': 'application/json',
            ...(currentToken ? { 'Authorization': `Bearer ${currentToken}` } : {}),
            ...options.headers,
        };
        showLoading();
        try {
            let resp = await fetch(url, options);
            if (resp.status === 401) {
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    currentToken = localStorage.getItem('jwtToken');
                    options.headers['Authorization'] = `Bearer ${currentToken}`;
                    resp = await fetch(url, options);
                } else {
                    throw new Error('Sessão expirada. Por favor, faça login novamente.');
                }
            }
            if (!resp.ok) {
                let err = `Erro ${resp.status}`;
                try { 
                    const data = await resp.json();
                    err = data.detail || data.message || err; 
                } catch {}
                const error = new Error(err);
                error.status = resp.status;
                throw error;
            }
            return await resp.json();
        } finally {
            hideLoading();
        }
    }

    async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) return false;
        try {
            const resp = await fetch('/api/token/refresh/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refresh: refreshToken })
            });
            if (!resp.ok) throw new Error('Refresh token inválido');
            const data = await resp.json();
            localStorage.setItem('jwtToken', data.access);
            return true;
        } catch (e) {
            localStorage.clear();
            return false;
        }
    }

    async function loadActivitiesForInitiation() {
        showLoading();
        if (!boxId) {
            console.warn('Box ID is not selected. Cannot load activities for initiation.');
            showToast('Selecione um box para ver as atividades disponíveis.', 'info');
            if (atividadesIniciarList) atividadesIniciarList.innerHTML = ''; // Clear activities if no box
            if (iniciarBtn) iniciarBtn.style.display = 'none';
            hideLoading();
            return;
        }
        try {
            const atividades = await fetchAPI('/api/boxes/atividades-disponiveis/', {method: 'GET'}); 
            console.log("Atividades recebidas para iniciar:", atividades);
            if (atividadesIniciarList) {
                atividadesIniciarList.innerHTML = '';
                if (atividades.length > 0) {
                    atividades.forEach(atividade => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <span><input type="checkbox" value="${atividade.id}" class="form-check-input me-2"> ${atividade.nome}</span>
                            <span class="badge bg-primary rounded-pill">${atividade.duracao_estimada} min</span>
                        `;
                        atividadesIniciarList.appendChild(li);
                    });
                    if (iniciarBtn) iniciarBtn.style.display = 'inline-block';
                } else {
                    atividadesIniciarList.innerHTML = '<li class="list-group-item text-muted">Nenhuma atividade disponível.</li>';
                    if (iniciarBtn) iniciarBtn.style.display = 'none';
                }
            } else {
                console.warn('Activities list (atividades-iniciar-list) element not found.');
            }
        } catch (error) {
            showToast('Erro ao carregar atividades: ' + error.message, 'danger');
            console.error('Erro ao carregar atividades para iniciar:', error);
        } finally {
            hideLoading();
        }
    }

    async function loadActivitiesForAdding() {
        showLoading();
        // Garante que boxId está definido
        if (!boxId && selectBox && selectBox.value) {
            boxId = selectBox.value;
            console.log('[LOG] boxId recuperado do selectBox em loadActivitiesForAdding:', boxId);
        }
        
        if (!boxId) {
            console.warn('[LOG] Box ID is not selected. Cannot load activities for adding.');
            showToast('Selecione um box para adicionar atividades.', 'info');
            if (atividadesListAdicionar) atividadesListAdicionar.innerHTML = ''; // Clear activities if no box
            hideLoading();
            return;
        }

        try {
            console.log('[LOG] Carregando atividades para adicionar. boxId:', boxId);
            const allActivities = await fetchAPI('/api/boxes/atividades-disponiveis/', {method: 'GET'});
            console.log('[LOG] Todas as atividades disponíveis:', allActivities);

            let currentSessionActivities = [];
            if (sessaoId) {
                const sessionDataResponse = await fetchAPI(`/api/verificar-sessao/`, {method: 'GET'});
                if (sessionDataResponse && sessionDataResponse.active_session) {
                    currentSessionActivities = sessionDataResponse.active_session.atividades.map(a => a.id);
                }
            }
            console.log('[LOG] Atividades na sessão atual (IDs):', currentSessionActivities);

            if (atividadesListAdicionar) {
                atividadesListAdicionar.innerHTML = '';
                const filteredActivities = allActivities.filter(activity => 
                    !currentSessionActivities.includes(activity.id)
                );
                console.log('[LOG] Atividades filtradas para adicionar:', filteredActivities);

                if (filteredActivities.length > 0) {
                    filteredActivities.forEach(atividade => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <span><input type="checkbox" value="${atividade.id}" class="form-check-input me-2"> ${atividade.nome}</span>
                            <span class="badge bg-primary rounded-pill">${atividade.duracao_estimada} min</span>
                        `;
                        atividadesListAdicionar.appendChild(li);
                    });
                    console.log('[LOG] <ul id="atividades-adicionar-list"> preenchido:', atividadesListAdicionar.innerHTML);
                } else {
                    atividadesListAdicionar.innerHTML = '<li class="list-group-item text-muted">Nenhuma atividade para adicionar.</li>';
                    console.log('[LOG] Nenhuma atividade para adicionar.');
                }
            } else {
                console.warn('[LOG] Activities list for adding (atividades-adicionar-list) element not found.');
            }
        } catch (error) {
            showToast('Erro ao carregar atividades para adicionar: ' + error.message, 'danger');
            console.error('[LOG] Erro ao carregar atividades para adicionar:', error);
        } finally {
            hideLoading();
        }
    }

    function renderSessionActivities(activities) {
        if (sessionActivitiesList) {
            sessionActivitiesList.innerHTML = '';
            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <span><i class="bi bi-check-circle-fill text-success me-2"></i> ${activity.atividade.nome}</span>
                        <span class="badge bg-secondary rounded-pill">${activity.atividade.duracao_estimada} min</span>
                    `;
                    sessionActivitiesList.appendChild(li);
                });
            } else {
                sessionActivitiesList.innerHTML = '<li class="list-group-item text-muted">Nenhuma atividade na sessão.</li>';
            }
        } else {
            console.warn('Session activities list (session-activities-list) element not found.');
        }
    }

    async function checkLoginStatus() {
        console.log("checkLoginStatus() started. boxId at start:", boxId);
        console.log("Verificando status de login...");
        showLoading();
        try {
            const token = localStorage.getItem('jwtToken');
            const storedFuncionario = localStorage.getItem('funcionario');

            if (token && storedFuncionario) {
                funcionario = JSON.parse(storedFuncionario);
                console.log("Token e funcionário encontrados no localStorage. Tentando verificar sessão...");
                
                const data = await fetchAPI('/api/verificar-sessao/', {method: 'GET'});
                if (data && data.user) {
                    console.log("Sessão verificada com sucesso. Dados do usuário:", data.user);
                    funcionario = data.user;
                    localStorage.setItem('funcionario', JSON.stringify(funcionario));
                    showAppView();
                    
                    if (data.active_session) {
                        console.log("Sessão ativa encontrada. Sessão ID:", data.active_session.id);
                        showStateActiveSession(data.active_session);
                    } else {
                        console.log("Nenhuma sessão ativa encontrada. Exibindo estado de iniciar nova sessão.");
                        showStateIniciar(boxId); // Pass currentBoxId to retain selection
                    }
                } else {
                    console.log("Verificação de sessão falhou ou não retornou dados do usuário. Exibindo login view.");
                    showLoginView();
                }
            } else {
                console.log("Token ou funcionário não encontrados no localStorage. Exibindo login view.");
                showLoginView();
            }
        } catch (error) {
            console.error('Erro ao verificar status de login:', error);
            showToast('Erro ao verificar sessão: ' + error.message, 'danger');
            showLoginView();
        } finally {
            hideLoading();
            console.log("checkLoginStatus() finished.");
        }
    }

    // --- Time and Progress Bar Management ---
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            seconds.toString().padStart(2, '0')
        ].join(':');
    }

    function startSessionTimer() {
        if (sessionTimer) {
            clearInterval(sessionTimer);
        }

        const timerDisplay = document.querySelector('.timer-display');
        const infoInicioSessao = document.getElementById('info-inicio-sessao');

        if (!startTime) {
            console.error("startTime não definido para o cronômetro da sessão.");
            return;
        }

        sessionTimer = setInterval(() => {
            const currentTime = new Date();
            const elapsedTime = currentTime - startTime;
            let remainingTime = totalSessionEstimatedDuration * 60 * 1000 - elapsedTime;

            if (remainingTime <= 0) {
                clearInterval(sessionTimer);
                sessionTimer = null;
                remainingTime = 0;
            }

            const formattedTime = formatTime(remainingTime);
            timerDisplay.textContent = formattedTime;
            infoInicioSessao.textContent = `Início: ${new Date(startTime).toLocaleTimeString()}`;

            if (sessionProgressBarContainer) {
                let progressPercentage = 0;
                if (totalSessionEstimatedDuration > 0) {
                    progressPercentage = Math.max(0, Math.min(100, Math.round((elapsedTime / (totalSessionEstimatedDuration * 60 * 1000)) * 100)));
                }
                sessionProgressBar.style.width = `${progressPercentage}%`;
                sessionProgressBar.setAttribute('aria-valuenow', progressPercentage);
            }

            if (sessionElapsedTime) {
                sessionElapsedTime.textContent = formatTime(elapsedTime);
            }
            if (sessionRemainingTime) {
                sessionRemainingTime.textContent = formatTime(remainingTime);
            }
        }, 100);
    }

    // --- EVENT LISTENERS ---
    matriculaForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('[LOG] Formulário de matrícula submetido');
        const matricula = matriculaInput.value.trim();
        if (!matricula) {
            console.log('[LOG] Matrícula vazia');
            showToast('Por favor, digite sua matrícula', 'warning');
            return;
        }
        if (!boxId) {
            console.log('[LOG] Box não selecionado');
            showToast('Por favor, selecione um box', 'warning');
            return;
        }
        console.log('[LOG] Buscando funcionário por matrícula:', matricula);
        showLoading();
        try {
            const response = await fetch(`/api/funcionarios/?matricula=${encodeURIComponent(matricula)}`);
            const data = await response.json();
            console.log('[LOG] Resposta da API (funcionarios):', data);
            if (response.ok && Array.isArray(data) && data.length > 0) {
                currentMatricula = matricula;
                funcionario = data[0];
                console.log('[LOG] Matrícula encontrada, mostrando modal de senha');
                if (senhaModal) {
                    senhaModal.show();
                } else {
                    console.error('[LOG] Modal de senha não encontrado');
                }
            } else {
                console.log('[LOG] Matrícula não encontrada');
                showToast('Matrícula não encontrada', 'danger');
            }
        } catch (error) {
            console.error('[LOG] Erro ao buscar funcionário:', error);
            showToast('Erro ao buscar funcionário: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    });

    senhaForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('[LOG] Formulário de senha submetido');
        const senha = senhaInput.value.trim();
        if (!senha) {
            console.log('[LOG] Senha vazia');
            showToast('Por favor, digite sua senha', 'warning');
            return;
        }
        console.log('[LOG] Enviando senha para autenticação');
        showLoading();
        try {
            const response = await fetch('/api/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    matricula: currentMatricula,
                    senha: senha
                })
            });
            const data = await response.json();
            console.log('[LOG] Resposta da API:', data);
            if (response.ok) {
                console.log('[LOG] Login bem sucedido, salvando tokens e dados do usuário');
                localStorage.setItem('jwtToken', data.access);
                localStorage.setItem('refreshToken', data.refresh);
                localStorage.setItem('funcionario', JSON.stringify(data.user));
                funcionario = data.user;
                jwtToken = data.access;
                refreshToken = data.refresh;
                if (senhaModal) {
                    senhaModal.hide();
                }
                showAppView();
                showStateIniciar(boxId);
            } else {
                console.log('[LOG] Erro na autenticação:', data.detail);
                showToast(data.detail || 'Senha incorreta', 'danger');
            }
        } catch (error) {
            console.error('[LOG] Erro ao fazer login:', error);
            showToast('Erro ao fazer login: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    });

    // Toggle password visibility
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', function() {
            console.log('[LOG] Toggle password visibility');
            const type = senhaInput.type === 'password' ? 'text' : 'password';
            senhaInput.type = type;
            const icon = this.querySelector('i');
            icon.classList.toggle('bi-eye');
            icon.classList.toggle('bi-eye-slash');
        });
    }

    if (atividadesFormIniciar) {
        atividadesFormIniciar.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!boxId) {
                showToast('Selecione um box.', 'danger');
                return;
            }
            // Coletar IDs das atividades selecionadas
            const checkboxes = atividadesFormIniciar.querySelectorAll('input[type="checkbox"]:checked');
            const atividades = Array.from(checkboxes).map(cb => parseInt(cb.value));
            if (atividades.length === 0) {
                showToast('Selecione pelo menos uma atividade.', 'danger');
                return;
            }
            showLoading();
            try {
                const response = await fetch(`/api/boxes/${boxId}/sessao-servico/iniciar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({ atividades })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Sessão iniciada com sucesso!', 'success');
                    showStateActiveSession(data);
                } else {
                    showToast(data.detail || 'Erro ao iniciar sessão.', 'danger');
                }
            } catch (error) {
                showToast('Erro ao iniciar sessão: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        });
    }

    if (finalizarSessaoBtn) {
        finalizarSessaoBtn.addEventListener('click', async function() {
            if (!sessaoId || !boxId) {
                showToast('Sessão ou box não encontrados.', 'danger');
                return;
            }
            showLoading();
            try {
                const response = await fetch(`/api/boxes/${boxId}/sessao-servico/finalizar/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({ sessao_id: sessaoId })
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('Sessão finalizada com sucesso!', 'success');
                    showStateIniciar(boxId);
                } else {
                    showToast(data.detail || 'Erro ao finalizar sessão.', 'danger');
                }
            } catch (error) {
                showToast('Erro ao finalizar sessão: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        });
    }

    if (adicionarTriggerBtn) {
        adicionarTriggerBtn.addEventListener('click', async function() {
            console.log('[LOG] Clique no botão Adicionar Atividade');
            // Garante que boxId está definido
            if (!boxId && selectBox && selectBox.value) {
                boxId = selectBox.value;
                console.log('[LOG] boxId recuperado do selectBox:', boxId);
            }
            // Exibir o mesmo bloco de seleção de atividades usado para iniciar sessão
            if (estadoIniciar && sessaoAtivaControls) {
                estadoIniciar.style.display = 'block';
                sessaoAtivaControls.style.display = 'none';
                if (atividadesTitle) atividadesTitle.textContent = 'Selecione atividades para adicionar:';
                if (iniciarBtn) {
                    iniciarBtn.textContent = 'Adicionar Atividades';
                    iniciarBtn.style.display = 'inline-block';
                }
                // Carregar atividades disponíveis para adicionar
                await loadActivitiesForAdding();
                // Trocar o event listener do formulário para adicionar atividades
                atividadesFormIniciar.onsubmit = async function(e) {
                    e.preventDefault();
                    // Verifica se boxId está definido
                    if (!boxId) {
                        console.log('[LOG] boxId não definido no submit');
                        showToast('Erro: Box não selecionado.', 'danger');
                        return;
                    }
                    const checkboxes = atividadesFormIniciar.querySelectorAll('input[type="checkbox"]:checked');
                    const atividades = Array.from(checkboxes).map(cb => parseInt(cb.value));
                    console.log('[LOG] IDs das atividades selecionadas para adicionar:', atividades);
                    if (atividades.length === 0) {
                        showToast('Selecione pelo menos uma atividade.', 'danger');
                        return;
                    }
                    showLoading();
                    try {
                        console.log('[LOG] Enviando POST para adicionar atividades. boxId:', boxId);
                        const response = await fetch(`/api/boxes/${boxId}/sessao-servico/adicionar-atividades/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${jwtToken}`
                            },
                            body: JSON.stringify({ atividades })
                        });
                        const data = await response.json();
                        console.log('[LOG] Resposta da API ao adicionar atividades:', data);
                        if (response.ok) {
                            showToast('Atividades adicionadas com sucesso!', 'success');
                            await atualizarSessaoEUI();
                        } else {
                            showToast(data.detail || 'Erro ao adicionar atividades.', 'danger');
                        }
                    } catch (error) {
                        console.error('[LOG] Erro ao adicionar atividades:', error);
                        showToast('Erro ao adicionar atividades: ' + error.message, 'danger');
                    } finally {
                        hideLoading();
                    }
                };
            }
        });
    }

    // Adiciona evento para cancelar adicionar atividades
    if (cancelarAdicionarBtn) {
        cancelarAdicionarBtn.addEventListener('click', function() {
            if (atividadesFormAdicionar) atividadesFormAdicionar.style.display = 'none';
            if (adicionarTriggerBtn) adicionarTriggerBtn.style.display = 'inline-block';
            if (finalizarSessaoBtn) finalizarSessaoBtn.style.display = 'inline-block';
        });
    }

    // Habilita o botão só se houver seleção
    if (atividadesFormAdicionar) {
        atividadesFormAdicionar.addEventListener('change', function() {
            const checkboxes = atividadesFormAdicionar.querySelectorAll('input[type="checkbox"]:checked');
            const btnConfirmar = document.getElementById('btn-confirmar-adicao');
            if (btnConfirmar) btnConfirmar.disabled = checkboxes.length === 0;
        });
    }

    // --- INITIALIZATION ---
    console.log('[LOG] Iniciando carregamento dos boxes');
    // Chamada para carregar os boxes ao iniciar
    await loadBoxes();
    console.log('[LOG] Verificando status de login');
    // Verificar status de login
    await checkLoginStatus();

    // Garante que o botão de adicionar atividade sempre terá o event listener
    const btnAdicionar = document.getElementById('adicionarAtividadesBtn');
    if (btnAdicionar) {
        btnAdicionar.addEventListener('click', function() {
            console.log('[LOG] Clique no botão Adicionar Atividade');
            showAdicionarAtividades();
        });
    } else {
        console.warn('[LOG] Botão Adicionar Atividade não encontrado no DOM');
    }
});

async function atualizarSessaoEUI() {
    // 1. Buscar dados atualizados da sessão
    const sessionData = await fetchAPI('/api/verificar-sessao/', {method: 'GET'});
    if (sessionData && sessionData.active_session) {
        renderSessionActivities(sessionData.active_session.atividades);
    }
    // 2. Verificar se ainda há atividades para adicionar
    const atividadesDisponiveis = await fetchAPI('/api/boxes/atividades-disponiveis/', {method: 'GET'});
    const btnAdicionar = document.getElementById('adicionarAtividadesBtn');
    if (atividadesDisponiveis.length === 0 && btnAdicionar) {
        btnAdicionar.style.display = 'none';
    } else if (btnAdicionar) {
        btnAdicionar.style.display = 'block';
    }
    // Esconde o formulário de adicionar atividades, se estiver aberto
    if (atividadesFormAdicionar) atividadesFormAdicionar.style.display = 'none';
    if (finalizarSessaoBtn) finalizarSessaoBtn.style.display = 'inline-block';
}
</script>
{% endblock %}